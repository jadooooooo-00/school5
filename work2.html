<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµ ì¡°ì¢…ë¡€ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .grade-all { background-color: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .grade-1 { background-color: #dcfce7; color: #166534; border-left: 4px solid #22c55e; } 
        .grade-2 { background-color: #e0e7ff; color: #3730a3; border-left: 4px solid #6366f1; } 
        .grade-3 { background-color: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; } 
        .calendar-day { min-height: 140px; transition: 0.2s; border: 0.5px solid #e5e7eb; background: white; }
        .calendar-day:hover { background-color: #f9fafb; z-index: 10; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .event-item { font-size: 0.75rem; padding: 4px 8px; margin-top: 4px; border-radius: 4px; font-weight: 600; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="p-4">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-[100]">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-2"></div>
        <p class="text-sm font-bold text-gray-600">ë°ì´í„° ì—°ê²° ì¤‘...</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row items-center justify-between mb-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-2xl font-black text-gray-900 tracking-tight">ğŸ« ì¡°ì¢…ë¡€ ì•Œë¦¬ë¯¸</h1>
                <p class="text-blue-600 font-medium text-sm">ì œê³µí•´ì£¼ì‹  ìµœì‹  URLë¡œ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button onclick="fetchData()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-5 rounded-xl transition">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="checkAdminAccess('add')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg">+ ì¼ì • ë“±ë¡</button>
            </div>
        </header>

        <div class="flex flex-wrap gap-2 mb-6" id="filterBar">
            <button onclick="filterGrade('all')" class="px-5 py-2 rounded-full font-bold transition bg-gray-800 text-white" data-g="all">ì „ì²´ë³´ê¸°</button>
            <button onclick="filterGrade('1')" class="px-5 py-2 rounded-full font-bold transition bg-white text-gray-600 border" data-g="1">1í•™ë…„</button>
            <button onclick="filterGrade('2')" class="px-5 py-2 rounded-full font-bold transition bg-white text-gray-600 border" data-g="2">2í•™ë…„</button>
            <button onclick="filterGrade('3')" class="px-5 py-2 rounded-full font-bold transition bg-white text-gray-600 border" data-g="3">3í•™ë…„</button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 id="monthTitle" class="text-xl font-bold text-gray-800"></h2>
                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded-md transition">â—€</button>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded-md transition">â–¶</button>
                </div>
            </div>
            <div class="grid grid-cols-7 text-center font-bold text-xs text-gray-400 py-3 bg-gray-50 border-b">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7"></div>
        </div>
    </div>

    <div id="addModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[110]">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 id="modalTitle" class="text-2xl font-bold mb-6">ğŸ“ ì¼ì • ê´€ë¦¬</h3>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <select id="inGrade" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"><option value="all">ì „ì²´ ê³µí†µ</option><option value="1">1í•™ë…„</option><option value="2">2í•™ë…„</option><option value="3">3í•™ë…„</option></select>
                <input type="date" id="inDate" class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                <input type="text" id="inTitle" placeholder="ì¼ì • ì œëª©" class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                <textarea id="inDesc" placeholder="ì•ˆë‚´ ë‚´ìš©" rows="3" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"></textarea>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('addModal')" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl">ì·¨ì†Œ</button>
                <button id="saveBtn" onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="viewModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[110]">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <div id="viewHeader" class="text-xs font-bold uppercase tracking-widest mb-2 px-2 py-1 inline-block rounded-md"></div>
            <h3 id="viewTitle" class="text-2xl font-bold mb-4"></h3>
            <div class="bg-gray-50 p-5 rounded-2xl mb-6 min-h-[120px] whitespace-pre-wrap text-gray-700" id="viewDesc"></div>
            <div class="flex gap-2">
                <button onclick="checkAdminAccess('edit')" class="bg-amber-50 text-amber-600 font-bold px-4 py-3 rounded-xl hover:bg-amber-100 transition">ìˆ˜ì •</button>
                <button onclick="checkAdminAccess('delete')" class="bg-red-50 text-red-600 font-bold px-4 py-3 rounded-xl hover:bg-red-100 transition">ì‚­ì œ</button>
                <button onclick="closeModal('viewModal')" class="flex-1 py-3 bg-gray-800 text-white font-bold rounded-xl hover:bg-gray-900 transition">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ìƒˆë¡œ ì£¼ì‹  URL ë°˜ì˜ ì™„ë£Œ
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcbbLdinP0cbp6mlghnVzztKUQqvBeN1qLyUUX_9xP-slnLG_bIn7TdZ6_oYjifMtdHw/exec";
        const ADMIN_PASSWORD = "1234"; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
        
        let date = new Date();
        let currentGradeFilter = 'all';
        let events = [];
        let selectedEvent = null;

        async function fetchData() {
            showLoading(true);
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                events = data;
                render();
            } catch (e) { 
                console.error(e);
                alert('ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°°í¬ ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.'); 
            } finally { showLoading(false); }
        }

        function render() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('monthTitle');
            grid.innerHTML = '';
            const year = date.getFullYear(); const month = date.getMonth();
            title.innerText = `${year}ë…„ ${month + 1}ì›”`;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="calendar-day bg-gray-50/50"></div>`;
            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayEvents = events.filter(e => {
                    const eDate = new Date(e.date).toISOString().split('T')[0];
                    return eDate === dateStr && (currentGradeFilter === 'all' || e.grade.toString() === currentGradeFilter || e.grade === 'all');
                });
                grid.innerHTML += `
                    <div class="calendar-day p-2">
                        <div class="text-xs font-bold ${new Date(dateStr).getDay() === 0 ? 'text-red-500' : 'text-gray-400'}">${d}</div>
                        <div class="mt-1 space-y-1">
                            ${dayEvents.map(e => `<div class="event-item grade-${e.grade}" onclick='viewDetail(${JSON.stringify(e).replace(/'/g, "&apos;")})'>${e.title}</div>`).join('')}
                        </div>
                    </div>`;
            }
        }

        function checkAdminAccess(mode) {
            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pw !== ADMIN_PASSWORD) return pw !== null && alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "ğŸ“ ì¼ì • ë“±ë¡";
                document.getElementById('editId').value = "";
                document.getElementById('inTitle').value = "";
                document.getElementById('inDesc').value = "";
                openModal('addModal');
            } else if (mode === 'edit') {
                document.getElementById('modalTitle').innerText = "âœï¸ ì¼ì • ìˆ˜ì •";
                document.getElementById('editId').value = selectedEvent.id;
                document.getElementById('inGrade').value = selectedEvent.grade;
                document.getElementById('inDate').value = new Date(selectedEvent.date).toISOString().split('T')[0];
                document.getElementById('inTitle').value = selectedEvent.title;
                document.getElementById('inDesc').value = selectedEvent.desc;
                closeModal('viewModal');
                openModal('addModal');
            } else if (mode === 'delete') {
                if(confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteEvent();
            }
        }

        async function saveEvent() {
            const btn = document.getElementById('saveBtn');
            const editId = document.getElementById('editId').value;
            const data = {
                id: editId || Date.now(),
                grade: document.getElementById('inGrade').value,
                date: document.getElementById('inDate').value,
                title: document.getElementById('inTitle').value,
                desc: document.getElementById('inDesc').value,
                action: editId ? 'edit' : 'add'
            };
            if(!data.date || !data.title) return alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                alert('ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë°˜ì˜ê¹Œì§€ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                closeModal('addModal');
                setTimeout(fetchData, 1500);
            } catch (e) { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            finally { btn.disabled = false; btn.innerText = "ì €ì¥í•˜ê¸°"; }
        }

        async function deleteEvent() {
            showLoading(true);
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ id: selectedEvent.id, action: 'delete' }) });
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('viewModal');
                setTimeout(fetchData, 1500);
            } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
        }

        function viewDetail(e) {
            selectedEvent = e;
            const h = document.getElementById('viewHeader');
            h.innerText = e.grade === 'all' ? 'ì „ì²´ ê³µí†µ' : `${e.grade}í•™ë…„ ê³µì§€`;
            h.className = `text-xs font-bold px-2 py-1 inline-block rounded-md mb-2 grade-${e.grade}`;
            document.getElementById('viewTitle').innerText = e.title;
            document.getElementById('viewDesc').innerText = e.desc || 'ë‚´ìš© ì—†ìŒ';
            openModal('viewModal');
        }

        function filterGrade(g) { 
            currentGradeFilter = g; 
            document.querySelectorAll('#filterBar button').forEach(btn => btn.className = btn.dataset.g === g ? "px-5 py-2 rounded-full font-bold transition bg-gray-800 text-white shadow-md" : "px-5 py-2 rounded-full font-bold transition bg-white text-gray-600 border"); 
            render(); 
        }
        function changeMonth(v) { date.setMonth(date.getMonth() + v); render(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showLoading(v) { document.getElementById('loadingOverlay').classList.toggle('hidden', !v); }
        window.onload = fetchData;
    </script>
</body>
</html>